<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.art1001.supply.mapper.tag.TagMapper">

    <resultMap id="BaseResultMap" type="com.art1001.supply.entity.tag.Tag">
        <result column="tag_id" property="tagId" jdbcType="BIGINT"/>
        <result column="tag_name" property="tagName" jdbcType="VARCHAR"/>
        <result column="bg_color" property="bgColor" jdbcType="VARCHAR"/>
        <result column="member_id" property="memberId" jdbcType="VARCHAR"/>
        <result column="project_id" property="projectId" jdbcType="VARCHAR"/>
        <result column="is_del" property="isDel" jdbcType="VARCHAR"/>
        <result column="create_time" property="createTime" jdbcType="BIGINT"/>
        <result column="update_time" property="updateTime" jdbcType="BIGINT"/>
    </resultMap>

    <sql id="Base_Column_List">
		tag_id,
		tag_name,
		bg_color,
		member_id,
		project_id,
            is_del,
		create_time,
		update_time
	</sql>

    <sql id="List_Column_List">
		tag_id,
		tag_name,
		bg_color
	</sql>

    <sql id="whereStatement">
        <where>
            1 = 1
            <if test="condition !=null">
            </if>
        </where>
    </sql>

    <select id="findTagPagerList" resultMap="BaseResultMap"
            parameterType="com.art1001.supply.entity.base.Pager">

        select * from prm_tag
        <include refid="whereStatement"/>

        <if test="orderBy == 0">
            order by tag_id desc
        </if>
        <if test="orderBy == 1">
            order by tag_id asc
        </if>

    </select>

    <select id="findTagAllList" resultMap="BaseResultMap"
            parameterType="com.art1001.supply.entity.tag.Tag">
        SELECT
        <include refid="Base_Column_List"/>
        from prm_tag
        <if test="orderBy == 0">
            order by tag_id desc
        </if>
        <if test="orderBy == 1">
            order by tag_id asc
        </if>
    </select>

    <select id="findById" resultMap="BaseResultMap" parameterType="java.lang.Integer">

        select
        <include refid="Base_Column_List"/>
        from prm_tag where tag_id = #{tagId} and is_del=0

    </select>

    <select id="findByPublicId" resultMap="BaseResultMap">

        select
        tg.tag_id,
        tg.tag_name,
        tg.bg_color
        from prm_tag tg left join prm_tag_relation tr on tg.tag_id = tr.tag_id
        where is_del=0
        <if test="publicType =='任务'">
             and tr.task_id = #{publicId}
        </if>
        <if test="publicType =='文件'">
            and tr.file_id = #{publicId}
        </if>
        <if test="publicType =='日程'">
            and tr.schedule_id = #{publicId}
        </if>
        <if test="publicType =='分享'">
            and tr.share_id = #{publicId}
        </if>
    </select>


    <select id="findTagByTagIds" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from prm_tag where is_del=0
        <if test="tagIds != null and tagIds != ''">
            and tag_id in
            <foreach collection="tagIds.split(',')" item="tagId" index="index" open="(" separator="," close=")">
                #{tagId}
            </foreach>
            order by tagId
            <foreach collection="tagIds.split(',')" item="tagId" index="index" open="(tag_id," separator="," close=")">
                 #{tagId}
            </foreach>
        </if>
        <if test="tagIds == null or tagIds == ''">
            and tag_id in('')
        </if>
    </select>

    <select id="findCountByTagName" parameterType="java.lang.String" resultType="java.lang.Integer">
		SELECT COUNT(0) FROM prm_tag
		WHERE
		  tag_name = #{tagName}
		and project_id = #{projectId} and is_del=0
	</select>

    <select id="findByProjectId" parameterType="java.lang.String" resultMap="BaseResultMap">
        select
        <include refid="Base_Column_List"/>
        from prm_tag
        where project_id = #{projectId} and is_del=0
    </select>

    <select id="findByIds" resultMap="BaseResultMap">
        select
        <include refid="List_Column_List"/>
        from prm_tag
        where is_del=0 and tag_id in
        <foreach collection="array" open="(" separator="," close=")" item="id">
            #{id}
        </foreach>

    </select>

    <delete id="deleteTagByTagId" parameterType="java.lang.Long">
		delete from
		prm_tag where tag_id = #{tagId}
		and project_id = #{projectId}
	</delete>

    <insert id="saveTag" keyProperty="tagId" useGeneratedKeys="true" parameterType="com.art1001.supply.entity.tag.Tag">

        insert into prm_tag
        <trim prefix="(" suffix=")" suffixOverrides=",">

            <if test="tagName != null and tagName != ''">
                tag_name,
            </if>
            <if test="bgColor != null and bgColor != ''">
                bg_color,
            </if>
            <if test="memberId != null and memberId != ''">
                member_id,
            </if>
            <if test="projectId != null and projectId != ''">
                project_id,
            </if>
            <if test="isDel != null and isDel != ''">
                is_del,
            </if>
            <if test="createTime != null and createTime != ''">
                create_time,
            </if>
            <if test="updateTime != null and updateTime != ''">
                update_time,
            </if>
        </trim>

        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="tagName != null and tagName != ''">
                #{tagName},
            </if>
            <if test="bgColor != null and bgColor != ''">
                #{bgColor},
            </if>
            <if test="memberId != null and memberId != ''">
                #{memberId},
            </if>
            <if test="projectId != null and projectId != ''">
                #{projectId},
            </if>
            <if test="isDel != null and isDel != ''">
                #{isDel},
            </if>
            <if test="createTime != null and createTime != ''">
                #{createTime},
            </if>
            <if test="updateTime != null and updateTime != ''">
                #{updateTime},
            </if>
        </trim>

    </insert>

    <update id="updateTag" parameterType="com.art1001.supply.entity.tag.Tag">

        update prm_tag
        <set>
            <if test="tagName != null and tagName != ''">
                tag_name = #{tagName},
            </if>
            <if test="bgColor != null and bgColor != ''">
                bg_color = #{bgColor},
            </if>
            <if test="memberId != null and memberId != ''">
                member_id = #{memberId},
            </if>
            <if test="projectId != null and projectId != ''">
                project_id = #{projectId},
            </if>
            <if test="isDel != null and isDel != ''">
                is_del = #{isDel},
            </if>
            <if test="updateTime != null and updateTime != ''">
                update_time = #{updateTime},
            </if>
        </set>

        WHERE tag_id = #{tagId}

    </update>

    <!-- 模糊查询标签 -->
    <select id="searchTag" resultMap="BaseResultMap">
        select <include refid="Base_Column_List"/>
        from prm_tag where tag_name like concat('%',#{tagName},'%') and is_del=0
    </select>

    <!-- 保存多条标签信息 -->
    <insert id="saveMany" useGeneratedKeys="true" keyProperty="tagId" parameterType="java.util.ArrayList">
        insert into prm_tag
        <trim prefix="(" suffix=")" suffixOverrides=",">
                tag_name,
                bg_color,
                member_id,
                project_id,
                create_time,
                update_time,
        </trim>
        values
        <foreach collection="list" separator="," item="tag">
            (
            <if test="tag.tagName != null and tag.tagName != ''">
                #{tag.tagName},
            </if>
            <if test="tag.bgColor != null and tag.bgColor != ''">
                #{tag.bgColor},
            </if>
            <if test="tag.memberId != null and tag.memberId != ''">
                #{tag.memberId},
            </if>
            <if test="tag.projectId != null and tag.projectId != ''">
                #{tag.projectId},
            </if>
            <if test="tag.createTime != null and tag.createTime != ''">
                #{tag.createTime},
            </if>
            <if test="tag.updateTime != null and tag.updateTime != ''">
                #{tag.updateTime}
            </if>
            )
        </foreach>
    </insert>

    <!-- 查询出在该项目回收站中的标签 -->
    <select id="findRecycleBin" parameterType="java.lang.String" resultMap="BaseResultMap">
        select <include refid="Base_Column_List"/>
        from prm_tag where is_del = 1 and project_id = #{projectId}
    </select>
</mapper>