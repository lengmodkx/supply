<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" th:href="@{/css/common.css}" href="../static/css/common.css">
    <link rel="stylesheet" type="text/css" th:href="@{/layui/css/layui.css}" href="../static/layui/css/layui.css">
    <link rel="stylesheet" type="text/css" th:href="@{/css/calendar-createtask.css}" href="../static/css/calendar-createtask.css">
</head>
<body>
<!-- 日历页面 创建 任务-->
<div class="create-calendar-task">
    <i class="layui-icon layui-icon-close close-tk" style="font-size: 16px; color: #a6a6a6;top: 15px;"></i>
    <div class="create-calendar-task-title">创建任务</div>
    <div class="content-box boxsizing layui-form">
        <div class="content-title">
            <!--选择 位置-->
            <div class="select-position boxsizing layui-form" style="display: none">
                <div class="select-position-title">选择位置
                    <i class="layui-icon layui-icon-close" style="font-size: 18px; color: #a6a6a6;"></i>
                </div>
                <div class="line"></div>
                <div class=" style-box">
                    <i class="layui-icon layui-icon-down down" style="font-size: 16px; color: gray;"></i>
                    <h3>项目</h3>
                    <select id="project"  lay-filter="project">
                        <option value="" selected="selected">请选择</option>
                        <option th:value="${project.projectId}" th:each="project:${projectList}" th:text="${project.projectName}"></option>
                    </select>
                </div>
                <div class="line"></div>
                <div class=" style-box">
                    <i class="layui-icon layui-icon-down down" style="font-size: 16px; color: gray;"></i>
                    <h3>分组</h3>
                    <select id="city" lay-verify="" lay-filter="groups">
                        <option value="" selected="selected">请选择</option>
                    </select>
                </div>
                <div class="line"></div>
                <div class=" style-box">
                    <i class="layui-icon layui-icon-down down" style="font-size: 16px; color: gray;"></i>
                    <h3>列表</h3>
                    <select id="menu" lay-verify="" lay-filter="list">
                        <option value="" selected="selected">请选择</option>
                    </select>
                </div>
                <div class="line"></div>
                <p class="fonts">你可以在任务版中添加和修改任务分组及任务列表</p>
                <div class="create-calendar-task-ok">确定</div>
            </div>



            <div class="content-title-box">
                <img src="../static/image/imgs.jpg" th:src="@{/image/close.png}" />
                <div>
                    <span class="title-one">请选择</span>
                    <span>·</span>
                    <span class="title-two">选择分组</span>
                    <span>·</span>
                    <span class="title-three">选择菜单</span>
                </div>
                <i class="layui-icon layui-icon-down" style="font-size: 16px; color: gray;"></i>
            </div>

        </div>
        <textarea name="" class="task-neirong boxsizing" placeholder="任务内容"></textarea>

        <div class="who-and-time">
            <div class="who-wrap">
                <img src="../static/image/adds.png" th:src="#{IMAGE_SERVER}+${user.userInfo.image}"/>
                <input type="hidden" th:value="${user.id}"/>
                <span th:text="${user.userName}"></span>
                <i class="layui-icon layui-icon-close-fill remove-who-wrap" style="font-size: 16px; color: #1E9FFF;"></i>
            </div>
            <div class="no-renling">
                <i class="layui-icon layui-icon-username no-people-img" style="font-size: 20px; color: #A6A6A6;"></i>
                <span>待认领</span>
            </div>
            <div class="time-wrap">
                <img src="../static/image/begintime.png" th:src="@{/image/begintime.png}"/>
                <input type="text" class="layui-input kaishi-time" id="beginTimes" placeholder="设置开始时间"/>
            </div>
            <div class="time-wrap">
                <img src="../static/image/overtime.png" th:src="@{/image/overtime.png}" />
                <input type="text" class="layui-input jieshu-time" id="overTimes" placeholder="设置截止时间"/>
            </div>

            <div class="no-repeat">
                <input type="hidden" id = "oldRepeat"/>
                <img class="repeat-img" src="../static/image/norepeat.png" th:src="@{/image/norepeat.png}" />
                <select name="repeat" lay-verify="" lay-filter = "repeat">
                    <option value="不重复">不重复</option>
                    <option value="每天重复">每天重复</option>
                    <option value="每周重复" >每周重复</option>
                    <option value="每月重复">每月重复</option>
                    <option value="每年重复">每年重复</option>
                    <option value="工作日重复">工作日重复</option>
                </select>
            </div>

            <div class="no-remand ">
                <img class="remand-img" src="../static/image/noremand.png" th:src="@{/image/noremand.png}" />
                <input type="hidden" id = "oldRemind"/>
                <select name="remand" lay-verify="" lay-filter = "remind">
                    <option value="不提醒">不提醒</option>
                    <option value="任务开始时提醒">任务开始时提醒</option>
                    <option value="任务截止时提醒">任务截止时提醒</option>
                </select>
            </div>
        </div>

        <div class="line"></div>

        <p class="cyz">参与者</p>
        <div class="work-people boxsizing clearfix">
            <div class="one-work-people">
                <img src="../static/image/add.png" th:src="#{IMAGE_SERVER}+${user.userInfo.image}" />
                <i class="layui-icon layui-icon-close-fill remove-work-people " style="font-size: 15px; color: #3da8f5;"></i>
            </div>
            <div class="add-work-people">
                <img src="../static/image/adds.png" th:src="@{/image/adds.png}" />
            </div>
        </div>

        <div class="line"></div>
    </div>
    <div class="footer boxsizing">
        <div class="foot-left">
            <img src="../static/image/suo.png">
            <span class="click-see">隐私模式:</span>
            <span class="set-see all-can-see" th:value="1">所有成员可见</span>
            <span class="set-see cyz-can-see" style="display: none" th:value="0">仅参与者可见</span>
        </div>
        <div class="create-ok">创建</div>

    </div>
</div>



</body>
<script th:src="@{/js/jquery-2.2.4.min.js}" src="../static/js/jquery-2.2.4.min.js"></script>
<script th:src="@{/layui/layui.js}" src="../static/layui/layui.js"></script>

<script>
    var project,groups,list;
    layui.use('form', function(){
        var form = layui.form;

        //监听提交
        form.on('submit(formDemo)', function(data){
            // layer.msg(JSON.stringify(data.field));
            // return false;
        });

        /**
         * 当选中了项目时 根据选中的项目获取分组信息
         */
        form.on('select(project)', function(data){
            //console.log(data.value); //得到被选中的值
            project=data.value;
            if(project == ''){
                return false;
            }
            var url = "/relation/projectAllGroup";
            var args = {"projectId":project};
            var content = '';
            $.post(url,args,function(data){
                var group = data.data;
                for(var i = 0;i < group.length;i++){
                        content+= '<option value="' + group[i].relationId + '">' + group[i].relationName + '</option>'
                }
                $('#city').append(content);
                form.render('select');
            },"json");
        });

        /**
         * 当选中了分组的时候触发事件
         */
        form.on('select(groups)', function(data){
            console.log(data.value); //得到被选中的值
            groups=data.value;
            if(groups == ''){
                return false;
            }
            var url = "/relation/groupAllMenu";
            var args = {"groupId":groups};
            var content = '';
            $.post(url,args,function(data){
                var menu = data.data;
                for(var i = 0;i < menu.length;i++){
                        content+= '<option value="' + menu[i].relationId + '">' + menu[i].relationName + '</option>'
                }
                $('#menu').append(content);
                form.render('select');
            },"json");
        });
        form.on('select(list)', function(data){
            console.log(data.value); //得到被选中的值
            list=data.value
        });
        //重复 提醒 图标变蓝色
        form.on('select(repeat)', function(data){
           if (data.value=="不重复"){
               $(".repeat-img").attr("src","../static/image/norepeat.png")
           }else {
               $(".repeat-img").attr("src","../static/image/repeat-blue.png")
           }

        });
        form.on('select(remind)', function(data){
            if(data.value =="不提醒"){
                $(".remand-img").attr("src","../static/image/noremand.png")
            }else{
                $(".remand-img").attr("src","../static/image/tixing-blue.png")
            }

        });
    });
    layui.use('laydate', function(){
        var laydate = layui.laydate;

        //执行一个laydate实例
        laydate.render({
            elem: '#beginTimes', //指定元素
            type:'datetime',
            format:'yyyy-MM-dd HH:00'
        });
        laydate.render({
            elem: '#overTimes', //指定元素
            type:'datetime',
            format:'yyyy-MM-dd HH:00'
        });
    });
    $(function () {

        //点击 标题 选择位置
        $(".content-title").click(function () {
            $(".select-position").show();
        });
        $(".select-position-title i").click(function (e) {
            $(".select-position").hide();
            e.stopPropagation()
        });
        //点击 选择位置 的确定按钮
        $(".create-calendar-task-ok").click(function (e) {
            $(".title-one").text($("#project").find("option:selected").text());
            $(".title-two").text($("#city").find("option:selected").text());
            $(".title-three").text($("#menu").find("option:selected").text());
            $(".select-position").hide();
            e.stopPropagation()

        });

        //点击 关闭按钮  关闭弹出层
        $(".close-tk").click(function () {
            var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
            parent.layer.close(index); //再执行关闭
        });

        //所有成员可见  参与者可见
        $(".click-see").click(function () {
            if ($(".all-can-see").is(":visible")) {
                $(".all-can-see").hide();
                $(".cyz-can-see").show();
            }else {
                $(".all-can-see").show();
                $(".cyz-can-see").hide();
            }
        });
        // 确定按钮 颜色 ，是否能点击
        $(".task-neirong").keyup(function () {
            if ($(this).val() !=''){
                $(".create-ok").css({"background-color":"#3da8f5","cursor":"pointer"})
            }else {
                $(".create-ok").css({"background-color":"#d9d9d9","cursor":"default"});
                $(".create-ok").click(function (e) {
                    e.preventDefault()
                })
            }
        });
        // 点击 x 出现待认领
        $(".remove-who-wrap").click(function () {
            $(".who-wrap").hide();
            $(".no-renling").show();
        });
        //点击添加人员 出现 弹框
        $(".add-work-people img").click(function () {
            if(project == undefined){
                layer.msg("必须选择一个项目!");
                return false;
            }
            var executorId = $('.who-wrap input[type="hidden"]').val();
            addpeople(executorId,'2');
        });

        //点击待认领的时候
        $('.no-renling').click(function () {
            if(project == undefined){
                layer.msg("必须选择一个项目!");
                return false;
            }
            addpeople('','1');
        });

    });

    //添加人员 弹框
    function addpeople(executorId,type) {
        layui.use('layer', function () {
            var layer = layui.layer;
            layer.open({
                type: 2,  //0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
                title: false, //标题
                offset: [0, 0],
                area: ['252px', '360px'],
                fixed: true,
                shadeClose: true,
                closeBtn: 0,
                shade: [0.1, '#fff'],
                anim: 1,  //动画 0-6
                content: "addPeople.html?projectId=" + project + "&executorId="+executorId+"&type="+type
            });
        });
    }

    /**
     * 更新任务的执行者的头像,名字,id
     * @param id 新的执行者的id
     * @param name 新的执行者的名字
     * @param img 新的执行者的头像
     */
    function changeExecutor(id,name,img){
        $('.who-wrap input[type="hidden"]').val(id);
        $('.who-wrap').children('img').attr('src',img);
        $('.who-wrap').children('span').html(name);
        $(".who-wrap").css("display","block");
    }

    /**
     * 添加添加选择完成后的参与者小头像
     * @param id 参与者id
     * @param name 参与者名称
     * @param img 参与者头像
     */
    function addMember(id,name,img){
        var content = '';
        if(id != ''){
            for(var i = 0;i < id.length;i++){
                content += '<div value = "' + id[i] + '" class="one-work-people">'+
                    '<input type="hidden" value="' + name[i] + '"  />'+
                    '<img src="'+ img[i] +'">'+
                    '<i class="layui-icon layui-icon-close-fill remove-work-people " style="font-size: 15px; color: #3da8f5;"></i>'+
                    '</div>';
            }
        }
        $(".add-work-people").before(content);
    }

    /**
     * 点击参与者右上角的 X 的时候 移除该参与者
     */
    $("html").on("click",".remove-work-people",function () {
       $(this).parent().remove();
    });

    /**
     * 单击创建任务时的触发事件
     */
    $('.create-ok').click(function () {
        if(list == undefined || list == ''){
            layer.msg("请您选择一个任务菜单");
            return false;
        }
        //获取选中的参与者信息
        var members = [];
        $('.work-people .one-work-people').each(function () {
            members.push($(this).attr('value'));
        });
        //设置任务的执行者
        var executor = $('.who-wrap input[type="hidden"]').val();
        //设置任务开始时间
        var beginTime = $('#beginTimes').val();
        if(beginTime != null && beginTime != ''){
            var startTime = new Date(beginTime.toString()).getTime();
        } else {
            startTime = null;
        }
        //设置任务结束时间
        var overTime = $('#overTimes').val();
        if(overTime != null && overTime != ''){
            var endTime = new Date(overTime.toString()).getTime();
        } else{
            endTime = null;
        }
        //设置任务的内容
        var taskName = $(".task-neirong ").val();
        //设置重复模式
        var repeat = $('[name = "repeat"]').val();
        //设置任务提醒
        var remind = $('[name="remand"]').val();
        //设置隐私模式
        var privacyPattern = "";
        if($('#privacyPattern').prop('checked')) {
            privacyPattern = "1";
        } else{
            privacyPattern = "0";
        }
        var url = "/task/saveTask";
        var args = {"startTime":startTime ,"endTime":endTime,"taskName":taskName,"repeat":repeat,"remind":remind,"privacyPattern":privacyPattern,"taskMenuId":list,"projectId" : project,"members":members.toString(),"executor":executor};
        $.post(url,args,function(data){
            if(data.result == 1){
                layer.msg("任务创建成功!");
                parent.layer.closeAll();
            } else{
                layer.msg("任务创建失败!");
            }
        },"json");
        return false;
    });

</script>
</html>