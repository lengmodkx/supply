<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" th:href="@{/css/common.css}" href="../static/css/common.css">
    <link rel="stylesheet" type="text/css" th:href="@{/layui/css/layui.css}" href="../static/layui/css/layui.css">
    <link rel="stylesheet" type="text/css" th:href="@{/css/myscheduling.css}" href="../static/css/myscheduling.css">
</head>
<body>
<!--编辑日程 弹框-->
<form class="edit-scheduling boxsizing layui-form">
    <div class="edit-scheduling-title">编辑日程
        <i class="layui-icon layui-icon-close close-tk" style="font-size: 16px; color: #a6a6a6;"></i>
    </div>
    <input type="hidden" th:value="${schedule.scheduleId}" class="scheduleId"/>
    <textarea th:name="scheduleName" th:text="${schedule.scheduleName}" placeholder="设计修改任务界面" class="layui-textarea"></textarea>
    <div class="begin-time abox">
        <input type="hidden" th:name="startTimeTemp" id="startTimeTemp" th:value="${startTimeTemp}"/>
        <img src="../static/image/begintime.png" th:src="@{/image/begintime.png}" />
        <input type="text" class="layui-input" id="beginTimes" placeholder="设置开始时间">
    </div>
    <div class="over-time abox">
        <input type="hidden" th:name="endTimeTemp" id="endTimeTemp" th:value="${endTimeTemp}"/>
        <img src="../static/image/begintime.png" th:src="@{/image/begintime.png}" />
        <input type="text" class="layui-input" id="overTimes" placeholder="设置截止时间">
    </div>
    <div class="no-repeat abox">
        <img src="../static/image/norepeat.png" th:src="@{/image/norepeat.png}" />
        <select name="repeat" lay-verify="">
            <option value="repeat-no" th:checked="${schedule.repeat=='不重复'}">不重复</option>
            <option value="repeat-day" th:checked="${schedule.repeat=='每天重复'}">每天重复</option>
            <option value="repeat-week" th:checked="${schedule.repeat=='每周重复'}">每周重复</option>
            <option value="repeat-mouth" th:checked="${schedule.repeat=='每月重复'}">每月重复</option>
            <option value="repeat-year" th:checked="${schedule.repeat=='每年重复'}">每年重复</option>
            <option value="repeat-workday" th:checked="${schedule.repeat=='工作日重复'}">工作日重复</option>
        </select>
    </div>
    <div class="no-remand abox">
        <img src="../static/image/noremand.png" th:src="@{/image/noremand.png}" />
        <select name="remind" lay-verify="">
            <option value="remand-no" th:checked="${schedule.remind=='不提醒'}">不提醒</option>
            <option value="remand-over" th:checked="${schedule.remind=='任务截止时提醒'}">任务截止时提醒</option>
            <option value="remand-begin" th:checked="${schedule.remind=='任务开始时提醒'}">任务开始时提醒</option>
        </select>
    </div>
    <div class="heng-line"></div>
    <p class="cyz">参与者</p>
    <div class="work-people boxsizing clearfix">
        <div class="one-work-people" th:each="user:${schedule.joinInfo}" th:value="${user.id}">
            <input type="hidden" id="memberId" th:value="${user.id}" th:name="memberId"/>
            <img src="../static/image/add.png" th:src="#{IMAGE_SERVER}+${user.userInfo.image}" />
            <i class="layui-icon layui-icon-close-fill remove-work-people " style="font-size: 15px; color: #3da8f5;"></i>
        </div>
        <div class="add-work-people" th:onclick="'javascript:addPeople(\''+${project.projectId}+'\')'">
            <img src="../static/image/adds.png" th:src="@{/image/adds.png}" />
        </div>
        <div style="float: right">
            <a href="https://zoom.us/start/videomeeting" target="_blank">video</a>
        </div>
    </div>
    <div class="heng-line"></div>
    <div class="edit-scheduling-ok">保存</div>
</form>
</body>
<script th:src="@{/js/jquery-2.2.4.min.js}" src="../static/js/jquery-2.2.4.min.js"></script>
<script th:src="@{/layui/layui.js}" src="../static/layui/layui.js"></script>
<script th:inline="javascript">
    var startTime = [[${startTime}]];
    var endTime = [[${endTime}]];
    var IMAGE_SERVER = [[#{IMAGE_SERVER}]];
    var scheduleId = $('scheduleId').val();

    layui.use('form', function(){
        var form = layui.form;
        form.on('switch(switch-filter)', function(data){
            console.log(data.elem.checked); //开关是否开启，true或者false
            if (data.elem.checked) {
                $(".who-can-see").text("仅自己可见")
            }else {
                $(".who-can-see").text("所有成员可见")
            }
        });
    });
    layui.use('element', function(){
        var element = layui.element;

    });
    layui.use('laydate', function(){
        var laydate = layui.laydate;

        //执行一个laydate实例
        //执行一个laydate实例
        laydate.render({
            elem: '#beginTimes', //指定元素
            type:'datetime',
            format:'yyyy-MM-dd HH:mm',
            value: startTime,
            isInitValue: true,
            done: function(value, date, endDate){
                $("#startTimeTemp").val(new Date(value).getTime());
            }
        });
        laydate.render({
            elem: '#overTimes', //指定元素
            type:'datetime',
            format:'yyyy-MM-dd HH:mm',
            value:endTime,
            isInitValue: true,
            done: function(value, date, endDate){
                $("#endTimeTemp").val(new Date(value).getTime());
            }
        });
    });
    
    $(".close-tk").click(function () {
        var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
        parent.layer.close(index); //再执行关闭
    })


    //添加人员 弹框
    function addPeople(projectId) {
        console.log("xxxxxxxxxx")
        layui.use('layer', function(){
            var layer = layui.layer;
            layer.open({
                type: 2,  //0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
                title: false, //标题
                area:['252px','360px'],
                fixed: true,
                shadeClose: true,
                closeBtn: 0,
                shade: [0.1, '#fff'],
                anim: 1,  //动画 0-6
                content: "/schedule/searchPeople.html?projectId="+projectId
            });
        });
    }

    /**
     * 添加添加选择完成后的参与者小头像
     * @param id 参与者id
     * @param name 参与者名称
     * @param img 参与者头像
     */
    function addMember(id,name,img){
        var content = '';
        if(id !== ''){
            for(var i = 0;i < id.length;i++){
                content += '<div  class="one-work-people">'+
                    '<input type="hidden" value = "' + id[i] + '" name="memberId"/>'+
                    '<img src="'+ img[i] +'">'+
                    '<i class="layui-icon layui-icon-close-fill remove-work-people " style="font-size: 15px; color: #3da8f5;"></i>'+
                    '</div>';
            }
        }
        $(".add-work-people").before(content);
    }

    //移除任务的参与者
    $("html").on("click",".remove-work-people",function () {
        var id = $(this).parent().attr("value");
        var args = {"scheduleId":scheduleId,"uId":id};
        var url = "/schedule/removeScheduleMember";
        $(this).parent().remove();
        $.post(url,args,function (data) {
            //getLog(data.taskLog);
            //移除完成
        },"json");
    });

    $('edit-scheduling-ok').click(function () {
        var params = $('.edit-scheduling').serialize();
        $.post("/schedule/addschedule",params,function (data) {
            if(data.result===1){
                parent.layer.msg(data.msg,{icon:1});
            }else{
                parent.layer.msg("更新失败",{icon:5});
            }
        });
        layer.closeAll();
        return false;
    });


</script>
</html>