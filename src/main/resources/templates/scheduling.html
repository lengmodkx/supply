<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head th:replace="common/common_header :: common_header(~{::title},~{::link})">
    <meta charset="UTF-8">
    <title></title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/common.css}" href="../static/css/common.css">
    <link rel="stylesheet" type="text/css" th:href="@{/layui/css/layui.css}" href="../static/layui/css/layui.css">
    <link rel="stylesheet" type="text/css" th:href="@{/css/mainpage.css}" href="../static/css/mainpage.css">
    <link rel="stylesheet" type="text/css" th:href="@{/css/commonhead.css}" href="../static/css/commonhead.css">
    <link rel="stylesheet" type="text/css" th:href="@{/css/share.css}" href="../static/css/share.css">
    <link rel="stylesheet" type="text/css" th:href="@{/css/revisetask.css}" href="../static/css/revisetask.css">
    <link rel="stylesheet" type="text/css" th:href="@{/css/myscheduling.css}" href="../static/css/myscheduling.css">
    <link rel="stylesheet" type="text/css" th:href="@{/css/chat.css}" href="../static/css/chat.css">
    <link rel="stylesheet" type="text/css" th:href="@{/css/file.css}" href="../static/css/file.css">
</head>
<body>
<header th:include="common/header::frag (${user.userInfo.image},${user.id})"></header>

<div th:include="toper::toper (${project},${groups},${currentGroup},${user})"></div>

<div class="content-wrap-wrap boxsizing">
    <div class="content boxsizing">
        <div id="date">
            <div class="add-scheduling">
                <div class="middle-box">
                    <img src="../static/image/adds.png"  th:src="@{/image/adds.png}" />
                    添加日程
                </div>
            </div>
            <!--//每一个折叠区域-->
            <div class="my-scheduling-box boxsizing layui-form">
                <div class="layui-tab layui-tab-brief">
                    <p style="padding-left: 10px;padding-top: 10px">日程</p>
                    <div class="layui-tab-content">
                        <div class="layui-tab-item layui-show">
                            <div class="layui-collapse">
                                <div class="layui-colla-item" th:each="schedulevo:${scheduleVo}">
                                    <h2 class="layui-colla-title" th:text="${schedulevo.date}">杜甫</h2>
                                    <div class="layui-colla-content">
                                        <ul id = "schedules">
                                            <li th:each="schedule:${schedulevo.scheduleList}" style="height: 30px" class="schedule" th:id="${schedule.scheduleId}">
                                                <div class="scheduling-time">
                                                    <span th:text="${#calendars.format(schedule.startTime,'MM-dd HH:mm')}">8:15</span>
                                                    <span>——</span>
                                                    <span th:text="${#calendars.format(schedule.endTime,'MM-dd HH:mm')}">16:15</span>
                                                </div>
                                                <div class="scheduling-name">
                                                    <span th:text="${schedule.scheduleName}">设计项目主机</span>
                                                </div>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
<script th:src="@{/js/ajaxfileupload.js}" src="../static/js/ajaxfileupload.js"></script>
<script th:inline="javascript">
    var groupId = [[${currentGroup}]];
    Date.prototype.format = function(format)
    {
        var o = {
            "M+" : this.getMonth()+1, //month
            "d+" : this.getDate(),    //day
            "h+" : this.getHours(),   //hour
            "m+" : this.getMinutes(), //minute
            "s+" : this.getSeconds(), //second
            "q+" : Math.floor((this.getMonth()+3)/3),  //quarter
            "S" : this.getMilliseconds() //millisecond
        }
        if(/(y+)/.test(format)) format=format.replace(RegExp.$1,
            (this.getFullYear()+"").substr(4 - RegExp.$1.length));
        for(var k in o)if(new RegExp("("+ k +")").test(format))
            format = format.replace(RegExp.$1,
                RegExp.$1.length==1 ? o[k] :
                    ("00"+ o[k]).substr((""+ o[k]).length));
        return format;
    }


    var projectId = [[${project.projectId}]];

    // 建立连接对象（还未发起连接）
    var socket = new SockJS("/webSocketServer");
    // 获取 STOMP 子协议的客户端对象
    var stompClient = Stomp.over(socket);

    // 向服务器发起websocket连接并发送CONNECT帧
    stompClient.connect({},
        function connectCallback(frame) {
            // 连接成功时（服务器响应 CONNECTED 帧）的回调方法
            console.log("连接成功");
            subscribe1();
        },
        function errorCallBack(error) {
            // 连接失败时（服务器响应 ERROR 帧）的回调方法
            console.log("连接失败");
        }
    );


    //订阅消息
    function subscribe1() {
        stompClient.subscribe('/topic/'+projectId, function (response) {
            var returnData = JSON.parse(response.body);
            var schedule = JSON.parse(returnData.responseMessage);
            var sche = schedule.schedule;
            if(schedule.type === '恢复了日程') {
                var content = '<li style="height: 30px" class="schedule" id="' + sche.scheduleId + '">\n' +
                    '                                                <div class="scheduling-time">\n' +
                    '                                                    <span>' + new Date(sche.startTime).format('MM-dd hh:ss') + '</span>\n' +
                    '                                                    <span>——</span>\n' +
                    '                                                    <span >' + new Date(sche.endTime).format('MM-dd hh:ss') + '</span>\n' +
                    '                                                </div>\n' +
                    '                                                <div class="scheduling-name">\n' +
                    '                                                    <span>' + sche.scheduleName + '</span>\n' +
                    '                                                </div>\n' +
                    '                                            </li>';

                $('.layui-colla-title').each(function () {
                    var s=$(this).text();
                 var date_s=s.substring(0,s.length-1);
                    if (date_s === schedule.date) {
                        $(this).siblings('.layui-colla-content').children('ul').append(content);
                    }
                });
            }
            if(schedule.type === '将日程移入了回收站') {
               $('#'+schedule.scheduleId).remove();
               // if($('#schedules li').length === 0){
               //     $('#schedules').parents('.layui-tab-item').remove();
               // }
            }

        });
    }

        $(function () {
        var url = window.location.href;
        if(url.indexOf("schedule") > 0){
            $(".toper-nav ul li:nth-of-type(4)").addClass("now").siblings().removeClass("now");
        }
    });


    $(".add-scheduling>.middle-box").click(function (e) {
        layui.use('layer', function() {
            var layer = layui.layer;
            layer.open({
                type: 2,  //0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
                title: false, //标题
                area: ['600px', '400px'],
                fixed: true,
                shadeClose: true,
                closeBtn: 0,
                shade: [0.1, '#fff'],
                anim: 1,  //动画 0-6
                content: "/schedule/addschedule.html?projectId=" + projectId
            });
        });
    });

    layui.use('element', function(){
        var element = layui.element;
    });




    $('html').on('click','.schedule',function () {
        var id = $(this).attr('id');

        layui.use('layer', function() {
            var layer = layui.layer;
            layer.open({
                type: 2,  //0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
                title: false, //标题
                area: ['600px', '536px'],
                fixed: true,
                shadeClose: true,
                closeBtn: 0,
                shade: [0.1, '#fff'],
                anim: 1,  //动画 0-6
                content: "/schedule/editSchedule.html?projectId=" + projectId+"&id="+id
            });
        });
    });
</script>
</html>
