<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" th:href="@{/css/common.css}" href="../static/css/common.css">
    <link rel="stylesheet" type="text/css" th:href="@{/layui/css/layui.css}" href="../static/layui/css/layui.css">
    <link rel="stylesheet" type="text/css" th:href="@{/css/calendar-create-rc.css}" href="../static/css/calendar-create-rc.css">

</head>
<body>
<!-- 日历页面 创建 日程-->
<input th:if="${rq != null}" type="hidden" th:value="${rq}" id="rq"/>
<form class="create-rc boxsizing layui-form" id="schedule-from">
<div class="create-rc boxsizing layui-form">
    <div class="create-rc-title  ">
       <span> 添加日程到</span>
            <select id="projectId"  lay-filter="project">
                    <option th:if="${index.first}" th:each="project,index:${projecs}" th:value="${project.projectId}" th:text="${project.projectName}" selected="selected"></option>
                    <option th:if="${!index.first}" th:each="project,index:${projecs}" th:value="${project.projectId}" th:text="${project.projectName}"></option>
            </select>
        <i class="layui-icon layui-icon-close" style="font-size: 16px; color: #a6a6a6;"></i>
    </div>
    <textarea class="rc-title boxsizing" placeholder="日程标题"></textarea>

    <div class="who-and-time">
        <div class="allday"><input type="checkbox" name="" title="全天" lay-skin="primary"></div>
        <div class="time-wrap">
            <img src="../static/image/begintime.png" th:src="@{/image/begintime.png}"/>
            <input type="text" class="layui-input kaishi-time" id="beginTimes" placeholder="设置开始时间" />
        </div>
        <div class="time-wrap">
            <img src="../static/image/overtime.png" th:src="@{/image/overtime.png}" />
            <input type="text" class="layui-input jieshu-time" id="overTimes" placeholder="设置截止时间"  />
        </div>

        <div class="no-repeat">
            <input type="hidden"  id = "oldRepeat"/>
            <img class="repeat-img" src="../static/image/norepeat.png" th:src="@{/image/norepeat.png}" />
            <select name="repeat" lay-verify="" lay-filter = "repeat">
                <option value="不重复" >不重复</option>
                <option value="每天重复" >每天重复</option>
                <option value="每周重复"  >每周重复</option>
                <option value="每月重复" >每月重复</option>
                <option value="每年重复" >每年重复</option>
                <option value="工作日重复" >工作日重复</option>
            </select>
        </div>

        <div class="no-remand ">
            <img class="remand-img" src="../static/image/noremand.png" th:src="@{/image/noremand.png}" />
            <input type="hidden"  id = "oldRemind"/>
            <select name="remand" lay-verify="" lay-filter = "remind">
                <option value="不提醒" >不提醒</option>
                <option value="日程开始时提醒" >日程开始时提醒</option>
                <option value="日程截止时提醒" >日程截止时提醒</option>
            </select>
        </div>
    </div>

    <div class="fonts">
        <input type="checkbox" name="" title="所有人都有时间" lay-skin="primary" checked >
    </div>
    <div class="line"></div>
    <p class="cyz">参与者</p>
    <div class="work-people boxsizing clearfix">
        <div class="one-work-people" th:value="${user.id}">
            <img src="../static/image/add.png" th:src="#{IMAGE_SERVER}+ ${user.userInfo.image}" />
            <i class="layui-icon layui-icon-close-fill remove-work-people " style="font-size: 15px; color: #3da8f5;"></i>
        </div>
        <div class="add-work-people">
            <img src="../static/image/adds.png" th:src="@{/image/adds.png}" />
        </div>
    </div>

    <div class="line"></div>
    <div class="footer boxsizing">
        <div class="foot-left">
            <img src="../static/image/suo.png" >
            <span class="click-see">隐私模式:</span>
            <span class="set-see all-can-see">所有成员可见</span>
            <span class="set-see cyz-can-see" style="display: none">仅参与者可见</span>
        </div>
        <button id="schedule_create" lay-submit class="layui-btn" lay-filter="scheduleCreate" style="background-color: #017ECA;float: right;margin-right: 10px">创建</button>

    </div>
</div>


</form>
</body>
<script th:src="@{/js/jquery-2.2.4.min.js}" src="../static/js/jquery-2.2.4.min.js"></script>
<script th:src="@{/layui/layui.js}" src="../static/layui/layui.js"></script>

<script>
    var startTime;
    var endTime;

    var project,groups,list,repeat,remind;
    layui.use('form', function(){
        var form = layui.form;

        //监听提交
        form.on('submit(formDemo)', function(data){
            layer.msg(JSON.stringify(data.field));
            return false;
        });
        form.on('select(project)', function(data){
            console.log(data.value); //得到被选中的值
            project=data.value
        });
        form.on('select(groups)', function(data){
            console.log(data.value); //得到被选中的值
            groups=data.value
        });
        form.on('select(list)', function(data){
            console.log(data.value); //得到被选中的值
            list=data.value
        });
        //重复 提醒 图标变蓝色
        form.on('select(repeat)', function(data){
           if (data.value=="不重复"){
               $(".repeat-img").attr("src","../static/image/norepeat.png")
           }else {
               $(".repeat-img").attr("src","../static/image/repeat-blue.png")
           }

        });
        form.on('select(remind)', function(data){
            if(data.value =="不提醒"){
                $(".remand-img").attr("src","../static/image/noremand.png")
            }else{
                $(".remand-img").attr("src","../static/image/tixing-blue.png")
            }

        });

        //监听提交
        form.on('submit(scheduleCreate)', function(data){
            var beginTime = $('#beginTimes').val();
            if(beginTime != null && beginTime != ''){
                var startTime = new Date(beginTime.toString()).getTime();
            } else {
                layer.msg("需要设置时间");
                return false;
            }

            var overTime = $('#overTimes').val();
            if(overTime != null && overTime != ''){
                var endTime = new Date(overTime.toString()).getTime();
            } else{
                layer.msg("需要设置时间");
                return false;
            }

            //设置重复模式
            var repeat = $('[name = "repeat"]').val();
            //设置任务提醒
            var remind = $('[name="remand"]').val();
            var projectId = $('#projectId').val();
            var scheduleName = $('.rc-title').val();
            //获取选中的参与者信息
            var members = [];
            $('.work-people .one-work-people').each(function () {
                members.push($(this).attr('value'));
            });


            var scheduleCalendar;
            if($('#rq').val() != null && $('#rq').val() != undefined){
                scheduleCalendar = $('#rq').val();
                var scheduleCalendar = new Date(scheduleCalendar.toString()).getTime();
            }

            var args = {"projectId":projectId,"scheduleName":scheduleName,"memberId":members.toString(),"startTimeTemp":startTime,"endTimeTemp":endTime,"repeat":repeat,"remand":remind,"scheduleCalendar":scheduleCalendar}

            $.post("/schedule/addschedule",args,function (data) {
                if(data.result===1){
                    parent.showSchedule(data.schedule);
                    parent.layer.msg(data.msg,{icon:1});
                }else{
                    parent.layer.msg("创建失败",{icon:5});
                }
            });
            parent.layer.closeAll();
            return false;
        });
    });



    layui.use('laydate', function(){
        var laydate = layui.laydate;

        //执行一个laydate实例
        laydate.render({
            elem: '#beginTimes', //指定元素
            type:'datetime',
            format:'yyyy-MM-dd H:00'
        });
        laydate.render({
            elem: '#overTimes', //指定元素
            type:'datetime',
            format:'yyyy-MM-dd H:00'
        });
    });
    $(function () {

        //点击 标题 选择位置
        $(".content-title").click(function () {
            $(".select-position").show();
        });
        $(".select-position-title i").click(function (e) {
            $(".select-position").hide();
            e.stopPropagation()
        });
        //点击 选择位置 的确定按钮
        $(".create-calendar-task-ok").click(function (e) {
            $(".title-one").text(project);
            $(".title-two").text(groups);
            $(".title-three").text(list);
            $(".select-position").hide();
            e.stopPropagation()

        });

        //点击 关闭按钮  关闭弹出层
        $(".create-rc-title i").click(function () {
            var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
            parent.layer.close(index); //再执行关闭
        });

        //所有成员可见  参与者可见
        $(".click-see").click(function () {
            if ($(".all-can-see").is(":visible")) {
                $(".all-can-see").hide();
                $(".cyz-can-see").show();
            }else {
                $(".all-can-see").show();
                $(".cyz-can-see").hide();
            }
        });
        // 确定按钮 颜色 ，是否能点击
        $(".rc-title").keyup(function () {
            if ($(this).val() !=''){
                $(".create-ok").css({"background-color":"#3da8f5","cursor":"pointer"})
            }else {
                $(".create-ok").css({"background-color":"#d9d9d9","cursor":"default"});
                $(".create-ok").click(function (e) {
                    e.preventDefault()
                })
            }
        });
        // 点击 x 出现待认领
        $(".remove-who-wrap").click(function () {
            $(".who-wrap").hide();
            $(".no-renling").show()
        });

        //点击添加人员 出现 弹框
        $(".add-work-people img").click(function () {
            if(project == undefined){
                layer.msg("必须选择一个项目!");
                return false;
            }
            addPeople(project);
        });


    });
    //添加人员 弹框
    function addPeople(projectId) {
        console.log("xxxxxxxxxx")
        layui.use('layer', function(){
            var layer = layui.layer;
            layer.open({
                type: 2,  //0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
                title: false, //标题
                area:['252px','360px'],
                fixed: true,
                shadeClose: true,
                closeBtn: 0,
                shade: [0.1, '#fff'],
                anim: 1,  //动画 0-6
                content: "/schedule/searchPeople.html?projectId="+projectId
            });
        });
    }

    function addMember(id,name,img){
        var content = '';
        if(id !== ''){
            for(var i = 0;i < id.length;i++){
                content += '<div  class="one-work-people" value = "' + id[i] + '">'+
                    '<input type="hidden" value = "' + id[i] + '" name="memberId"/>'+
                    '<img src="'+ img[i] +'">'+
                    '<i class="layui-icon layui-icon-close-fill remove-work-people " style="font-size: 15px; color: #3da8f5;"></i>'+
                    '</div>';
            }
        }
        $(".add-work-people").before(content);
    }

    /**
     * 点击参与者右上角的 X 的时候 移除该参与者
     */
    $("html").on("click",".remove-work-people",function () {
        $(this).parent().remove();
    });


</script>
</html>