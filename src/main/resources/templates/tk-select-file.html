<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" th:href="@{/css/common.css}" href="../static/css/common.css">
    <link rel="stylesheet" type="text/css" th:href="@{/layui/css/layui.css}" href="../static/layui/css/layui.css">
    <link rel="stylesheet" type="text/css" th:href="@{/css/select-file.css}" href="../static/css/select-file.css">
</head>
<body>
<!--复制文件 弹框-->
<div class="clone-project">
    <div class="clone-project-title boxsizing">
        <h4>从文件库选择</h4>
    </div>

    <div class="clone-project-content">
        <div class="clone-project-left">
            <p class="style-wjj boxsizing">文件夹</p>
            <div class="zong-wjj boxsizing">
                <img src="../static/image/wjj-b.png" th:src="@{/image/wjj-b.png}">
                <span>文件库</span>
            </div>
        </div>
       <div class="clone-project-right-box">
            <ul class="scroll-ul">
                <!--每一列-->
                <li class="column boxsizing" >
                    <div class="li-header boxsizing">
                        <input type="file" name="fileToUpload" id="fileToUpload" class="file-to-upload" data="0"/>
                        <i class="layui-icon layui-icon-upload-drag upload-file" style="font-size: 18px; color: #a6a6a6;"></i>
                        <i class="layui-icon layui-icon-add-circle create-wjj" style="font-size: 18px; color: #a6a6a6;"></i>
                    </div>
                    <p class="style-wjj boxsizing">文件夹</p>
                    <div class="new-wjj boxsizing"><input type="text" placeholder="按 Enter 新建文件夹" data="0"></div>
                    <ul class="wjj-ul">
                        <li class="style-li boxsizing over-hidden" th:each="file : ${fileList}" th:if="${file.catalog eq 1}" th:id="${file.fileId}">
                            <img src="../static/image/wjj-b.png" th:src="@{/image/wjj-b.png}">
                            <span th:text="${file.fileName}">文件夹</span>
                        </li>
                    </ul>
                    <p class="style-wjj boxsizing">文件</p>
                    <ul class="wj-ul">
                        <li class="style-li boxsizing over-hidden" th:each="file : ${fileList}" th:if="${file.catalog eq 0}" th:id="${file.fileId}" th:data="${file.fileName}" th:value="${file.size}">
                            <img src="../static/image/defaultFile.png" th:src="@{/image/defaultFile.png}">
                            <span th:text="${file.fileName}">adkasd.zip</span>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>

    <div class="clone-project-foot boxsizing">
        <div class="clone-no">取消</div>
        <div class="clone-ok">确定</div>
    </div>


</div>
<!--<div class="new-wjj boxsizing"><input  type="text" placeholder="按 Enter 新建文件夹"></div>-->
</body>
<script th:src="@{/js/jquery-2.2.4.min.js}" src="../static/js/jquery-2.2.4.min.js"></script>
<script th:src="@{/layui/layui.js}" src="../static/layui/layui.js"></script>
<script th:inline="javascript">
    var projectId = [[${projectId}]];
    var windowName = [[${windowName}]];
    layui.use(['form','upload'], function(){
        var form = layui.form;
    });
    
    
    
    
    //点击 添加文件夹
    $("html").on("click",".create-wjj",function (e) {
        $(this).parent().siblings(".new-wjj").show();
        e.stopPropagation()
    });
    //点击空白区域 新建 文件夹 输入框 消失
    $("html").on("click",".new-wjj input",function (e) {
       e.stopPropagation()
    });
    $("html").on("keydown",".new-wjj input",function (e) {
        if(event.keyCode ===13) {
            $(this).parent().hide();
            var folderName = $(this).attr('data');
            if (folderName !== '') {
                layer.load();
                $.post("/file/createFolder", {
                    projectId: projectId,
                    parentId: $(this).val(),
                    folderName: folderName
                }, function (data) {
                    layer.closeAll('loading');
                    if (data.result === 1) {
                        $(this).parent().siblings(".wjj-ul").prepend(' <li class="style-li boxsizing over-hidden" id="'+data.data.fileId+'">\n' +
                            '                                <img src="/image/wjj-b.png">\n' +
                            '                                <span>' + folderName + '</span>\n' +
                            '                            </li>');
                        $(this).parent().hide();
                    } else {
                        layer.msg(data.msg, {icon: 2, time: 1000})
                    }
                });
            }
        }

    });
    $(document).click(function(event){
        var _con = $('.new-wjj input');  // 设置目标区域
        if(!_con.is(event.target) && _con.has(event.target).length === 0){ // Mark 1
            $('.new-wjj').hide(100);     //淡出消失
        }
    });
    // 点击 增加now 类名
    $("html").on("click",".wjj-ul>li",function () {
        $(this).addClass("now").siblings().removeClass("now");
        $(this).parents(".column").nextAll().remove();
        layer.load();
        $.post('/file/childFile',{"projectId":projectId,"parentId":$(this).attr('id')},function (data) {
            layer.closeAll('loading');
            if(data.result===1){
                var fileList = data.data;
                var content = '<li class="column boxsizing">\n' +
                    '          <div class="li-header boxsizing">\n' +
                    '          <input type="file" name="fileToUpload" id="fileToUpload" class="file-to-upload" data="'+data.parentId+'"/><i class="layui-icon layui-icon-upload-drag upload-file" style="font-size: 18px; color: #a6a6a6;"></i>\n' +
                    '          <i class="layui-icon layui-icon-add-circle create-wjj" style="font-size: 18px; color: #a6a6a6;"></i>\n' +
                    '          </div>\n' +
                    '          <p class="style-wjj boxsizing">文件夹</p>\n' +
                    '          <div class="new-wjj boxsizing"><input  type="text" placeholder="按 Enter 新建文件夹" data="'+data.parentId+'"></div>\n' +
                    '          <ul class="wjj-ul">';

                    for(var i=0;i<fileList.length;i++){
                        var file = fileList[i];
                        if(file.catalog===1){
                            content+='<li class="style-li boxsizing over-hidden now" id="'+file.fileId+'"><img src="/image/wjj-b.png"/> <span>'+file.fileName+'</span></li>';
                        }
                    }

                    content+='</ul><p class="style-wjj boxsizing">文件</p><ul class="wj-ul">';

                    for(var j=0;j<fileList.length;j++){
                        var file1 = fileList[j];
                        if(file1.catalog===0){
                            content+='<li class="style-li boxsizing over-hidden" id="'+file1.fileId+'" data="'+file1.fileName+'" value="'+file1.size+'"><img src="/image/wjj-b.png"><span>'+file1.fileName+'</span></li>';
                        }
                    }
                content+='</ul></li>';

                $('.wjj-ul>li').parents(".column").after(content)
            }
        });

    });
    $("html").on("click",".wj-ul>li",function () {
       if ($(this).hasClass("now")){
           $(this).removeClass("now")
       } else {
           $(this).addClass("now")
       }
    });

    $('html').on('change','.file-to-upload',function (e) {
        var parentId = $(this).attr('data');
        var oMyForm = new FormData();
        oMyForm.append("parentId",parentId);
        oMyForm.append("projectId",projectId);
        oMyForm.append("file",e.currentTarget.files[0]);
        layer.load();
        $.ajax({
            url:"/file/uploadFile",
            type:"POST",
            data:oMyForm,
            async:false,
            cache:false,
            contentType:false,
            processData:false,
            success:function(returndata){
                layer.closeAll('loading');
                window.location.reload();
            },
            error:function(returndata){
                layer.closeAll('loading');
                layer.msg("error:"+returndata);
            }
        });
    });
     // 关闭弹出层
    $(".clone-no").click(function () {
        var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
        parent.layer.close(index); //再执行关闭
    });

    $('.clone-ok').click(function () {
        $('.wj-ul li').each(function (data,item) {
            if($(item).hasClass('now')){
                var fileId = $(item).attr('id');
                var fileName = $(item).attr('data');
                var size = $(item).attr('value');
                var li ='<li class="boxsizing" id="' + fileId + '" style="width: 550px;height: 40px;background-color: #eee;padding: 4px 8px;line-height: 20px;font-size: 12px;margin: 2px auto;margin-top: 0"><div>' + fileName + ' (' + size + ')<i class="layui-icon layui-icon-close" style="font-size: 16px; color: gray;float: right;cursor: pointer"></i></div></li>';
                var ifrc = window.parent.frames[windowName];
                var winc = ifrc.window || ifrc.contentWindow;
                winc.$('.fileList').append(li);
            }
        });

        var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
        parent.layer.close(index); //再执行关闭
    });
</script>
</html>