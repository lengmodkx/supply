<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head th:replace="common/common_header :: common_header(~{::title},~{::link})">
    <meta charset="UTF-8">
    <title>忘记密码</title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/common.css}" href="../static/css/common.css">
    <link rel="stylesheet" type="text/css" th:href="@{/layui/css/layui.css}" href="../static/layui/css/layui.css">
    <link rel="stylesheet" type="text/css" th:href="@{/css/loginAndRegister.css}" href="../static/css/loginAndRegister.css">
</head>
<body>
<div class="forget-box">
    <h1>阿拉丁BIM云平台</h1>
    <form id="resetPwdForm" class="layui-form">
        <div class="phone-num-box">
            <input type="text" name="accountName" id="accountName" required lay-verify="required" placeholder="手机号或邮箱" autocomplete="off" class="layui-input phoneOrEmail">
        </div>

        <div class="pic-code-box">
            <input type="text" name="captcha"  id="captcha" required lay-verify="required" placeholder="验证码" autocomplete="off" class="layui-input">
            <img src="/captcha.html" class="pic-code" onclick="changeCaptcha()">
        </div>
        <div class="pic-code-box">
            <input type="text" name=""  required lay-verify="required" placeholder="短信验证" autocomplete="off" class="layui-input">
            <div class="msg-code" id="msg-code">免费获取验证码</div>
        </div>
        <div class="pwd-box">
            <input type="password" name="password" required lay-verify="required" placeholder="密码" autocomplete="off" class="layui-input">
        </div>
        <button id="register" lay-submit class="layui-btn layui-btn-fluid martop" lay-filter="resetPwd" style="background-color: #017ECA">重置密码</button>
    </form>
</div>

<script th:src="@{/js/jquery-2.2.4.min.js}" src="../static/js/jquery-2.2.4.min.js"></script>
<script th:src="@{/layui/layui.js}" src="../static/layui/layui.js"></script>
<script th:src="@{/js/getcode.js}" src="../static/js/getcode.js"></script>
<script>

    function changeCaptcha() {
        $(".pic-code").attr("src","/captcha.html");
    }

    var countdown=60;
    $(".msg-code").click(function () {
        var accountName = $("#accountName").val();
        var captcha = $("#captcha").val();
        var obj = $(this);
        if (accountName===''){
            layer.msg("请输入手机号",{icon:5});
            return false;
        }

        if(captcha===''){
            layer.msg("请输入图形验证码",{icon:5});
            return false;
        }

        $.post("/code",{"accountName":accountName,"captcha":captcha},function (data) {
            if(data.result===1){
                settime(obj);
                layer.msg(data.msg,{icon:1});
            }else{
                layer.msg(data.msg,{icon:5});
            }
        });

    });

    function settime(obj) { //发送验证码倒计时
        if (countdown === 0) {
            obj.removeClass('btn-disabled');
            obj.text("免费获取验证码");
            countdown = 60;
            return;
        } else {
            obj.addClass('btn-disabled');
            obj.text("重新发送(" + countdown + ")");
            countdown--;
        }
        setTimeout(function() {settime(obj)},1000)
    }

    layui.use('form', function(){
        var form = layui.form;
        //监听提交
        form.on('submit(resetPwd)', function(){
            var regsj=/^[1][3,4,5,7,8][0-9]{9}$/;
            var regyx=/^(\w-*\.*)+@(\w-?)+(\.\w{2,})+$/;
            var phoneNum = regsj.test(accountName);
            var email=regyx.test(accountName);

            if(phoneNum||email){
                var params = $("#resetPwdForm").serialize();
                var index = layer.load(1, {shade: [0.1,'#fff']});
                $.post("/forget", params, function (data) {
                    layer.close(index);
                    if(data.result===1){
                        layer.msg(data.msg,{icon: 1});
                        window.location.href = "/";
                    }else{
                        changeCaptcha();
                        layer.msg(data.msg,{icon: 5});
                    }
                })
            }else{
                layer.msg("请输入正确的手机号或邮箱",{icon: 5});
            }
            return false;
        });
    });


</script>
</body>
</html>