<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head th:fragment="common_header(title,links)">
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <link rel="stylesheet" th:href="@{/css/common.css}" >
    <link rel="stylesheet" th:href="@{/layui/css/layui.css}" >
    <link rel="stylesheet" th:href="@{/css/commonhead.css}">
    <link rel="stylesheet" href="http://at.alicdn.com/t/font_754098_4lhdkbtcjjc.css">
    <link rel="stylesheet" type="text/css" th:href="@{/css/group.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/css/search-people.css}">
    <script th:src="@{/js/jquery-2.2.4.min.js}"></script>
    <script th:src="@{/layui/layui.js}"></script>
    <script th:src="@{/js/Sortable.min.js}"></script>
    <script th:src="@{/js/sockjs.js}"></script>
    <script th:src="@{/js/stomp.js}"></script>
    <script th:src="@{/js/clipboard.min.js}"></script>
    <script th:src="@{/js/jquery-ui.min.js}"></script>
    <script th:inline="javascript">
        var IMAGE_SERVER = [[#{IMAGE_SERVER}]];
        $(function () {
            // 群组 弹框
            $(".team").click(function () {
                var left=$(window).width()-350;
                var top=$(window).height()-100;
                var projectId = $(this).attr('id');
                groups(top,left,projectId);
            });

            function groups(top,left,projectId) {
                layui.use('layer', function(){
                    var layer = layui.layer;
                    layer.open({
                        type: 1,  //0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
                        title: false, //标题
                        offset: ['100px',left],
                        area:['350px',top+'px'],
                        fixed: true,
                        shadeClose: true,
                        closeBtn: 0,
                        shade: 0,
                        anim: 0,  //动画 0-6
                        content: $(".group-box"),
                        success:function () {
                            $('.group-people').html('');
                            $.post('/findAllProjectMember',{"projectId":projectId},function (data) {
                                if(data.result===1){
                                    var projectMember = data.data;
                                    for(var i=0;i<projectMember.length;i++){
                                       var li = '<li class="boxsizing">\n' +
                                           '            <img src="'+IMAGE_SERVER+projectMember[i].memberImg+'">\n' +
                                           '            <div class="group-people-info">\n' +
                                           '                <p class="people-info-name">'+projectMember[i].memberName+'</p>\n' +
                                           '                <p class="people-info-email" style="display: none"></p>\n' +
                                           '            </div>';
                                            if(projectMember[i].memberLable===0){
                                                li+='<i class="layui-icon layui-icon-down" style="font-size: 20px; color: #a6a6a6;" id="'+projectMember[i].id+'"></i>';
                                            }
                                            li+='</li>';
                                       $('.group-people').append(li);
                                    }
                                }
                            });
                        }
                    });
                });

            }


            //群组 人员  下箭头 弹框
            $("body").on("click",".group-people>li>i",function (e) {
                e.stopPropagation();
                var top=$(this).offset().top-110;
                var left=$(this).offset().left-280;
                var nodeName = $(this).attr('id');
                parent.layer.open({
                    type: 2,  //0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
                    title: false, //标题
                    offset: [top,left],
                    area:['280px','185px'],
                    fixed: true,
                    shadeClose: true,
                    closeBtn: 0,
                    shade: 0,
                    anim: 1,  //动画 0-6
                    content: '/removePeople.html?nodeName='+nodeName
                });

            });

            //群组 邀请成员 弹框
            //点击邀请新成员
            $(".add-new-member").click(function (e) {
                $('.invitation').html('');
                yaoqing();
                e.stopPropagation()
            });
            function yaoqing() {
                layui.use('layer', function(){
                    var layer = layui.layer;
                    layer.open({
                        type: 1,  //0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
                        title: "邀请新成员", //标题
                        offset: '150px',
                        fixed: false,
                        shadeClose: true, //点击遮罩关闭
                        anim: 1,  //动画 0-6
                        content: $(".search_prople")
                    });
                });
            }

            //点击菜单，打开项目菜单区域
            $(".menu").click(function () {
                var top=$(this).offset().top +40 +'px';
                var right=$(window).width()-$(this).offset().left;
                var left=$(this).offset().left -380 +right+'px';
                projectMenu(top,left);
            });
            function projectMenu(top,left) {
                layui.use('layer', function(){
                    var layer = layui.layer;
                    layer.open({
                        type: 2,  //0（信息框，默认）1（页面层）2（iframe层）3（加载层）4（tips层）
                        title: false, //标题
                        offset: [top,left],
                        area:['380px','500px'],
                        fixed: true,
                        shadeClose: true,
                        closeBtn: 0,
                        shade: 0,
                        anim: 1,  //动画 0-6
                        content: ['projectMenu.html?projectId='+projectId,'no']
                    });
                });
            }

            //群组 部分 的js
            //点击 关闭按钮  关闭弹出层
            $(".close-people").click(function () {
                layer.close(layer.index)
            });
            $(".close-tk").click(function () {
                layer.closeAll('page');
            });

            $('.user_search').click(function (e) {
                $('.invitation').html('');
                var index = layer.load(1, {shade: [0.1,'#fff']});
                $.post('/searchMember',{"keyword":$('.keyword').val()},function (data) {
                    parent.layer.close(index);
                    if(data.result===1){
                        for(var i=0;i<data.data.length;i++){
                            var user = data.data[i];
                            var li = '<li>\n' +
                                '            <img src="'+IMAGE_SERVER+user.userInfo.image+'" >\n' +
                                '            <span class="people-name">'+user.userName+'</span>\n' +
                                '            <span class="people-state no-join" data="'+user.id+'">添加</span>\n' +
                                '        </li>';
                            $('.invitation').append(li);
                        }
                    }else{

                    }
                });
            });


            $("html").on("click",".people-box .people-state",function () {
                var id = $(this).attr('data');
                $.post('/addProjectMember',{"projectId":projectId,"memberIds":id},function (data) {
                    if(data.result===1){
                        $('.group-people').html('');
                        for(var i=0;i<data.data.length;i++) {
                            var projectMember = data.data[i];
                            var li = '<li class="boxsizing">\n' +
                                '            <img src="'+IMAGE_SERVER + projectMember.memberImg+'">\n' +
                                '            <div class="group-people-info">\n' +
                                '                <p class="people-info-name">'+projectMember.memberName+'</p>\n' +
                                '                <p class="people-info-email"></p></div>';
                            if(projectMember.memberLable===0){
                                li += '<i class="layui-icon layui-icon-down" style="font-size: 20px; color: #a6a6a6;" id="'+projectMember.id+'"></i></li>';
                            }else{
                                li += '</li>';
                            }

                            $('.group-people').append(li);
                        }
                    }
                    $(this).removeClass("no-join")
                });
            });


        });

    </script>
    <title th:replace="${title}">The awesome application</title>
    <th:block th:replace="${links}" />

</head>

</html>